<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        Threezh1&#39;Blog
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            DevTools里的JSFinder与油猴脚本
        </p>
        <hr>
    </div>
    <div class="post-content">
        <!--Table of Contents begin-->
        
            <div id="toc" class="toc-article">
            <strong class="toc-title">目录</strong>
            <a class="js-toggle-toc" href="javascript:void(0)"></a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87html%E6%BA%90%E7%A0%81%E9%87%8C%E7%9A%84%E5%90%84%E7%A7%8D%E8%BF%9E%E6%8E%A5%E8%8E%B7%E5%8F%96%E5%AD%90%E5%9F%9F%E5%90%8D"><span class="toc-text">通过html源码里的各种连接获取子域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0jsfinder%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3"><span class="toc-text">实现jsfinder获取所有接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSFinder%E6%B2%B9%E7%8C%B4%E8%84%9A%E6%9C%AC"><span class="toc-text">JSFinder油猴脚本</span></a></li></ol>
            </div>
            </div>
        
        <!--Table of Contents end -->
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>于前天在推特上看到Hpdoger师傅转了一个推：</p>
<p><img src="https://sanzhi-1259392731.cos.ap-chengdu.myqcloud.com/2020/12/11/16076219424271.jpg" alt="-w746"></p>
<p>是一个人分享了一段javascript代码，在DevTools上执行可以直接获取到html所有标签属性里的url。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urls = []</span><br><span class="line">$$(<span class="string">&#x27;*&#x27;</span>).forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">  urls.push(element.src)</span><br><span class="line">  urls.push(element.href)</span><br><span class="line">  urls.push(element.url)</span><br><span class="line">&#125;); <span class="built_in">console</span>.log(...new <span class="built_in">Set</span>(urls))</span><br></pre></td></tr></table></figure>

<p>以小米官网为例：</p>
<p><img src="https://sanzhi-1259392731.cos.ap-chengdu.myqcloud.com/2020/12/11/16076221055725.jpg" alt="-w1790"></p>
<p>这段js代码的作用把我吓到了，6行代码把jsfinder的功能实现的差不多了…我仔细研究了一下，发现它只是遍历的标签的属性，却没有对js文件里的url进行提取。只是简单的遍历的话没什么太大的用，所以我打算自己根据这个思路，把jsfinder上的功能往这个上面挪一挪。</p>
<p>下面就是三个不同的程度的利用：</p>
<ol>
<li>通过html源码里的各种连接获取子域名</li>
<li>实现jsfinder获取所有接口</li>
<li>JSFinder油猴脚本</li>
</ol>
<h2 id="通过html源码里的各种连接获取子域名"><a href="#通过html源码里的各种连接获取子域名" class="headerlink" title="通过html源码里的各种连接获取子域名"></a>通过html源码里的各种连接获取子域名</h2><p>获取根域名我参考了这篇文章：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/195912">https://developer.aliyun.com/article/195912</a> 相比于直接截断判断，文章中这种获取的方式就靠谱很多了。<br>直接贴源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">urls = []; domains = [];</span><br><span class="line">$$(<span class="string">&#x27;*&#x27;</span>).forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    urls.push(element.src);urls.push(element.href);urls.push(element.url);</span><br><span class="line">&#125;); urls = <span class="keyword">new</span> <span class="built_in">Set</span>(urls);</span><br><span class="line">urls.forEach(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url != <span class="literal">undefined</span> &amp;&amp; url != <span class="string">&quot;&quot;</span> &amp;&amp; url.startsWith(<span class="string">&quot;http&quot;</span>) == <span class="literal">true</span>)&#123;</span><br><span class="line">        url = <span class="keyword">new</span> URL(url);</span><br><span class="line">        <span class="keyword">if</span> (url.host.endsWith(getMainHost()) == <span class="literal">true</span>) &#123;</span><br><span class="line">            domains.push(url.host)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(domains)));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMainHost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key  = <span class="string">`mh_<span class="subst">$&#123;<span class="built_in">Math</span>.random()&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">let</span> keyR = <span class="keyword">new</span> <span class="built_in">RegExp</span>( <span class="string">`(^|;)\\s*<span class="subst">$&#123;key&#125;</span>=12345`</span> );</span><br><span class="line">  <span class="keyword">let</span> expiredTime = <span class="keyword">new</span> <span class="built_in">Date</span>( <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">let</span> domain = <span class="built_in">document</span>.domain;</span><br><span class="line">  <span class="keyword">let</span> domainList = domain.split( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">  <span class="keyword">let</span> urlItems   = [];</span><br><span class="line">  urlItems.unshift( domainList.pop() );</span><br><span class="line">  <span class="keyword">while</span>( domainList.length ) &#123;</span><br><span class="line">    urlItems.unshift( domainList.pop() );</span><br><span class="line">    <span class="keyword">let</span> mainHost = urlItems.join( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">    <span class="keyword">let</span> cookie   = <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;<span class="number">12345</span>&#125;</span>;domain=.<span class="subst">$&#123;mainHost&#125;</span>`</span>;</span><br><span class="line">    <span class="built_in">document</span>.cookie = cookie;</span><br><span class="line">    <span class="keyword">if</span> ( keyR.test( <span class="built_in">document</span>.cookie ) ) &#123;</span><br><span class="line">      <span class="built_in">document</span>.cookie = <span class="string">`<span class="subst">$&#123;cookie&#125;</span>;expires=<span class="subst">$&#123;expiredTime&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">return</span> mainHost;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://sanzhi-1259392731.cos.ap-chengdu.myqcloud.com/2020/12/11/16076228671417.jpg" alt="-w1786"></p>
<h2 id="实现jsfinder获取所有接口"><a href="#实现jsfinder获取所有接口" class="headerlink" title="实现jsfinder获取所有接口"></a>实现jsfinder获取所有接口</h2><p>只获取域名是不太够的，接着来获取接口(严格来说这里其实也是url，只不过把js里面的url也提取出来了)。</p>
<p>这里有几个简单的问题存在：</p>
<ol>
<li>接口存在于js文件里，怎么通过js获取js文件内容？</li>
<li>不同路径的处理是不是跟jsfinder原来一样需要写很多的判断处理语句？</li>
<li>接口到底是获取全子域的还是只获取当前域的？</li>
</ol>
<p>这些问题对应的解决办法：</p>
<ol>
<li>可以直接用xmlHttpRequest同步方法获取文件内容</li>
<li>不需要，可以使用<code>new URL()</code>这种方式组合url，会自动处理url中的层级关系 (这个有点好用)</li>
<li>只获取当前域的接口太少了，我选择的方式是连接获取当前域，接口获取全子域。这样既保证了爬取的页面不会太多，接口数量和质量也有所保障。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">urls = []; js_content=<span class="string">&quot;&quot;</span>; result_raw = [];</span><br><span class="line">$$(<span class="string">&#x27;*&#x27;</span>).forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    urls.push(element.src);urls.push(element.href);urls.push(element.url);</span><br><span class="line">    <span class="keyword">if</span> (element.tagName == <span class="string">&quot;SCRIPT&quot;</span>) &#123; js_content += element.text &#125;</span><br><span class="line">&#125;); urls = <span class="keyword">new</span> <span class="built_in">Set</span>(urls);</span><br><span class="line">urls.forEach(<span class="function"><span class="params">rawurl</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rawurl != <span class="literal">undefined</span> &amp;&amp; rawurl != <span class="string">&quot;&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(rawurl) == <span class="string">&quot;string&quot;</span> &amp;&amp; rawurl.startsWith(<span class="string">&quot;http&quot;</span>) == <span class="literal">true</span>)&#123;</span><br><span class="line">        url = <span class="keyword">new</span> URL(rawurl);</span><br><span class="line">        <span class="keyword">if</span> (url.host.endsWith(location.host) == <span class="literal">true</span> &amp;&amp; url.pathname.endsWith(<span class="string">&quot;.js&quot;</span>) == <span class="literal">true</span>) &#123;</span><br><span class="line">            result_raw = result_raw.concat(extract_url(geturlContent(url.pathname)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">result_raw = result_raw.concat(extract_url(js_content));</span><br><span class="line">result = [];</span><br><span class="line">result_raw.forEach(<span class="function"><span class="params">url</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;jpeg|png|gif|svg|js|flv|swf|css&quot;</span>.search(<span class="keyword">new</span> URL(url).pathname.split(<span class="string">&#x27;.&#x27;</span>).pop().toLowerCase()) == -<span class="number">1</span>)&#123;</span><br><span class="line">        result.push(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(result)));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMainHost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key  = <span class="string">`mh_<span class="subst">$&#123;<span class="built_in">Math</span>.random()&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">let</span> keyR = <span class="keyword">new</span> <span class="built_in">RegExp</span>( <span class="string">`(^|;)\\s*<span class="subst">$&#123;key&#125;</span>=12345`</span> );</span><br><span class="line">  <span class="keyword">let</span> expiredTime = <span class="keyword">new</span> <span class="built_in">Date</span>( <span class="number">0</span> );</span><br><span class="line">  <span class="keyword">let</span> domain = <span class="built_in">document</span>.domain;</span><br><span class="line">  <span class="keyword">let</span> domainList = domain.split( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">  <span class="keyword">let</span> urlItems   = [];</span><br><span class="line">  urlItems.unshift( domainList.pop() );</span><br><span class="line">  <span class="keyword">while</span>( domainList.length ) &#123;</span><br><span class="line">    urlItems.unshift( domainList.pop() );</span><br><span class="line">    <span class="keyword">let</span> mainHost = urlItems.join( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">    <span class="keyword">let</span> cookie   = <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;<span class="number">12345</span>&#125;</span>;domain=.<span class="subst">$&#123;mainHost&#125;</span>`</span>;</span><br><span class="line">    <span class="built_in">document</span>.cookie = cookie;</span><br><span class="line">    <span class="keyword">if</span> ( keyR.test( <span class="built_in">document</span>.cookie ) ) &#123;</span><br><span class="line">      <span class="built_in">document</span>.cookie = <span class="string">`<span class="subst">$&#123;cookie&#125;</span>;expires=<span class="subst">$&#123;expiredTime&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">return</span> mainHost;d</span><br><span class="line">    &#125;&#125;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">geturlContent</span>(<span class="params">pathname</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    request.open(<span class="string">&quot;GET&quot;</span>, pathname, <span class="literal">false</span>);</span><br><span class="line">    request.send();</span><br><span class="line">    <span class="keyword">if</span>(request.status === <span class="number">200</span>)&#123;</span><br><span class="line">        result = request.responseText;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extract_url</span>(<span class="params">js_content</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> regex = <span class="regexp">/(?:&quot;|&#x27;)(((?:[a-zA-Z]&#123;1,10&#125;:\/\/|\/\/)[^&quot;&#x27;\/]&#123;1,&#125;\.[a-zA-Z]&#123;2,&#125;[^&quot;&#x27;]&#123;0,&#125;)|((?:\/|\.\.\/|\.\/)[^&quot;&#x27;&gt;&lt;,;| *()(%%$^\/\\\[\]][^&quot;&#x27;&gt;&lt;,;|()]&#123;1,&#125;)|([a-zA-Z0-9_\-\/]&#123;1,&#125;\/[a-zA-Z0-9_\-\/]&#123;1,&#125;\.(?:[a-zA-Z]&#123;1,4&#125;|action)(?:[\?|\/][^&quot;|&#x27;]&#123;0,&#125;|))|([a-zA-Z0-9_\-]&#123;1,&#125;\.(?:php|asp|aspx|jsp|json|action|html|js|txt|xml)(?:\?[^&quot;|&#x27;]&#123;0,&#125;|)))(?:&quot;|&#x27;)/</span>sg;</span><br><span class="line">    <span class="keyword">let</span> m; result = [];</span><br><span class="line">    <span class="keyword">while</span> ((m = regex.exec(js_content)) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (m.index === regex.lastIndex) &#123; regex.lastIndex++;&#125;</span><br><span class="line">    m.forEach(<span class="function">(<span class="params">match, groupIndex</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (match != <span class="literal">undefined</span>) &#123;</span><br><span class="line">            match = match.replaceAll(<span class="regexp">/(&#x27;|&quot;)/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (match.startsWith(<span class="string">&quot;http&quot;</span>) == <span class="literal">true</span>)&#123;</span><br><span class="line">                suburl = <span class="keyword">new</span> URL(match);</span><br><span class="line">                <span class="keyword">if</span> (suburl.host.endsWith(getMainHost()) == <span class="literal">true</span>)&#123; result.push(match); &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                url = <span class="keyword">new</span> URL(match, location.origin);</span><br><span class="line">                <span class="keyword">if</span> (url.host.endsWith(getMainHost()) == <span class="literal">true</span>)&#123; result.push(url.href); &#125;</span><br><span class="line">            &#125;&#125;&#125;);&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://sanzhi-1259392731.cos.ap-chengdu.myqcloud.com/2020/12/11/16076232670876.jpg" alt="-w1788"></p>
<h2 id="JSFinder油猴脚本"><a href="#JSFinder油猴脚本" class="headerlink" title="JSFinder油猴脚本"></a>JSFinder油猴脚本</h2><p>如果每次去获取域名接口都要复制一段js代码的话，那就太麻烦了。所以就写了一个油猴脚本来方便使用，每次打开网站都会自动的获取域名与接口。自己在网站测试过程中也可以自行设置域名范围(在油猴脚本中修改<code>match</code>配置)。</p>
<p>最终源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         JSFinder</span></span><br><span class="line"><span class="comment">// @namespace    Threezh1</span></span><br><span class="line"><span class="comment">// @version      0.2</span></span><br><span class="line"><span class="comment">// @description  Extract interfaces from html and javascript files.</span></span><br><span class="line"><span class="comment">// @author       Threezh1</span></span><br><span class="line"><span class="comment">// @match        *://*/*</span></span><br><span class="line"><span class="comment">// @require      https://greasyfork.org/scripts/12447-mootools-for-greasemonkey/code/MooTools%20for%20Greasemonkey.js?version=74469</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">    &#x27;use strict&#x27;</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;JSFinder by Threezh1&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> urls = []; <span class="keyword">let</span> js_content=<span class="string">&quot;&quot;</span>; <span class="keyword">let</span> result_raw = []; <span class="keyword">let</span> domains = [];</span><br><span class="line">    $$(<span class="string">&#x27;*&#x27;</span>).forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">        urls.push(element.src);urls.push(element.href);urls.push(element.url);</span><br><span class="line">        <span class="keyword">if</span> (element.tagName == <span class="string">&quot;SCRIPT&quot;</span>) &#123; js_content += element.text &#125;</span><br><span class="line">    &#125;); urls = <span class="keyword">new</span> <span class="built_in">Set</span>(urls);</span><br><span class="line">    urls.forEach(<span class="function"><span class="params">rawurl</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rawurl != <span class="literal">undefined</span> &amp;&amp; rawurl != <span class="string">&quot;&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(rawurl) == <span class="string">&quot;string&quot;</span> &amp;&amp; rawurl.startsWith(<span class="string">&quot;http&quot;</span>) == <span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> url = <span class="keyword">new</span> URL(rawurl);</span><br><span class="line">            <span class="keyword">if</span> (url.host.endsWith(getMainHost()) == <span class="literal">true</span>) &#123; domains.push(url.host) &#125;;</span><br><span class="line">            <span class="keyword">if</span> (url.host.endsWith(location.host) == <span class="literal">true</span> &amp;&amp; url.pathname.endsWith(<span class="string">&quot;.js&quot;</span>) == <span class="literal">true</span>) &#123;</span><br><span class="line">                result_raw = result_raw.concat(extract_url(geturlContent(url.pathname)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    result_raw = result_raw.concat(extract_url(js_content));</span><br><span class="line">    <span class="keyword">var</span> result = [];</span><br><span class="line">    result_raw.forEach(<span class="function"><span class="params">url</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> URL(url).host.endsWith(getMainHost()) == <span class="literal">true</span>) &#123; domains.push(<span class="keyword">new</span> URL(url).host) &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;jpeg|png|gif|svg|js|flv|swf|css&quot;</span>.search(<span class="keyword">new</span> URL(url).pathname.split(<span class="string">&#x27;.&#x27;</span>).pop().toLowerCase()) == -<span class="number">1</span>)&#123;</span><br><span class="line">            result.push(url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;JSFinder get domains: &quot;</span>, <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(domains)));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;JSFinder get urls: &quot;</span>, <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(result)));</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMainHost</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> key = <span class="string">`mh_<span class="subst">$&#123;<span class="built_in">Math</span>.random()&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">let</span> keyR = <span class="keyword">new</span> <span class="built_in">RegExp</span>( <span class="string">`(^|;)\\s*<span class="subst">$&#123;key&#125;</span>=12345`</span> );</span><br><span class="line">        <span class="keyword">let</span> expiredTime = <span class="keyword">new</span> <span class="built_in">Date</span>( <span class="number">0</span> );</span><br><span class="line">        <span class="keyword">let</span> domain = <span class="built_in">document</span>.domain;</span><br><span class="line">        <span class="keyword">let</span> domainList = domain.split( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">        <span class="keyword">let</span> urlItems = [];</span><br><span class="line">        urlItems.unshift( domainList.pop() );</span><br><span class="line">        <span class="keyword">while</span>( domainList.length ) &#123;</span><br><span class="line">            urlItems.unshift( domainList.pop() );</span><br><span class="line">            <span class="keyword">let</span> mainHost = urlItems.join( <span class="string">&#x27;.&#x27;</span> );</span><br><span class="line">            <span class="keyword">let</span> cookie = <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;<span class="number">12345</span>&#125;</span>;domain=.<span class="subst">$&#123;mainHost&#125;</span>`</span>;</span><br><span class="line">            <span class="built_in">document</span>.cookie = cookie;</span><br><span class="line">            <span class="keyword">if</span> ( keyR.test( <span class="built_in">document</span>.cookie ) ) &#123;</span><br><span class="line">                <span class="built_in">document</span>.cookie = <span class="string">`<span class="subst">$&#123;cookie&#125;</span>;expires=<span class="subst">$&#123;expiredTime&#125;</span>`</span>;</span><br><span class="line">                <span class="keyword">return</span> mainHost;</span><br><span class="line">            &#125;&#125;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">geturlContent</span>(<span class="params">pathname</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        request.open(<span class="string">&quot;GET&quot;</span>, pathname, <span class="literal">false</span>);</span><br><span class="line">        request.send();</span><br><span class="line">        <span class="keyword">if</span>(request.status === <span class="number">200</span>)&#123;</span><br><span class="line">            result = request.responseText;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">extract_url</span>(<span class="params">js_content</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> regex = <span class="regexp">/(?:&quot;|&#x27;)(((?:[a-zA-Z]&#123;1,10&#125;:\/\/|\/\/)[^&quot;&#x27;\/]&#123;1,&#125;\.[a-zA-Z]&#123;2,&#125;[^&quot;&#x27;]&#123;0,&#125;)|((?:\/|\.\.\/|\.\/)[^&quot;&#x27;&gt;&lt;,;| *()(%%$^\/\\\[\]][^&quot;&#x27;&gt;&lt;,;|()]&#123;1,&#125;)|([a-zA-Z0-9_\-\/]&#123;1,&#125;\/[a-zA-Z0-9_\-\/]&#123;1,&#125;\.(?:[a-zA-Z]&#123;1,4&#125;|action)(?:[\?|\/][^&quot;|&#x27;]&#123;0,&#125;|))|([a-zA-Z0-9_\-]&#123;1,&#125;\.(?:php|asp|aspx|jsp|json|action|html|js|txt|xml)(?:\?[^&quot;|&#x27;]&#123;0,&#125;|)))(?:&quot;|&#x27;)/</span>sg;</span><br><span class="line">        <span class="keyword">let</span> m; result = [];</span><br><span class="line">        <span class="keyword">while</span> ((m = regex.exec(js_content)) !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m.index === regex.lastIndex) &#123; regex.lastIndex++;&#125;</span><br><span class="line">            m.forEach(<span class="function">(<span class="params">match, groupIndex</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (match != <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    match = match.replaceAll(<span class="regexp">/(&#x27;|&quot;)/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (match.startsWith(<span class="string">&quot;http&quot;</span>) == <span class="literal">true</span>)&#123;</span><br><span class="line">                        <span class="keyword">let</span> suburl = <span class="keyword">new</span> URL(match);</span><br><span class="line">                        <span class="keyword">if</span> (suburl.host.endsWith(getMainHost()) == <span class="literal">true</span>)&#123; result.push(match); &#125;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">let</span> url = <span class="keyword">new</span> URL(match, location.origin);</span><br><span class="line">                        <span class="keyword">if</span> (url.host.endsWith(getMainHost()) == <span class="literal">true</span>)&#123; result.push(url.href); &#125;</span><br><span class="line">                    &#125;&#125;&#125;);&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>在油猴处启动脚本之后打开小米官网，可以看到已经成功运行：</p>
<p><img src="https://sanzhi-1259392731.cos.ap-chengdu.myqcloud.com/2020/12/11/16076235698941.jpg" alt="-w1789"></p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Threezh1
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>